---
title: "Selecting cells within a cell segmentation table"
author: "Kent Johnson"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Selecting cells within a cell segmentation table}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup,echo=FALSE}
knitr::opts_chunk$set(eval=FALSE)
```

`phenoptr` includes a flexible mechanism for selecting cells (i.e. rows) from a
cell seg table. The mechanism is implemented in `select_rows` and 
usable from any function that supports it, 
including `count_touching_cells` and `count_within`.

----

## Selecting phenotypes

This section of the vignette uses the `from` parameter 
of `count_within` for examples.

### Select a single phenotype

The simplest selector is the name of a single phenotype. For example,
to select all `CD8+` cells as the `from` phenotype, use the parameter

```{r}
from='CD8+'
```

### Group multiple phenotypes

Multiple phenotypes may selected together by including each name in a 
character vector (not a list!).
For example, to select cells phenotyped as either 
`PDL1+ CK+` or `PDL1- CK+`,
use the parameter

```{r}
from=c('PDL1+ CK+', 'PDL1- CK+')
```

### Flexible selection using expressions

For more flexibility, `select_rows` supports selection using any valid
expression. Expressions are written using one-sided formulas. 
The formulas are evaluated in the context
of the cell seg table so they may reference any column of the table.

For example, to select cells with PDL1 expression greater than 3, use
an expression like ``~`Entire Cell PDL1 (Opal 520) Mean`>3``. 
In this example, the column name is `Entire Cell PDL1 (Opal 520) Mean`.

Expressions and phenotype names may be combined in a list. For example,
to select `CK+` cells with PDL1>3, use the parameter

```{r}
from=list('CK+', ~`Entire Cell PDL1 (Opal 520) Mean`>3)
```

A few things to note about formula expressions:

- Expressions are evaluated in the context of the cell seg table. Names
  used in the expression must match column names in the table. If the table
  was read using `read_cell_seg_data(path, remove_units=TRUE)` (the default),
  the table names will be abbreviated compared to the names in the file.
- Names which are not valid R symbol names---this includes most of the column
  names in a cell seg table---must be enclosed in backticks (`) as
  in the example above.
  
----

## Selecting pairs of phenotypes

Several functions in `phenoptr` operate on pairs of phenotypes 
and have arguments
`pairs` and `phenotype_rules`. These functions build on `select_rows` to
allow allow flexible selection of pairs of phenotypes. 

### Pairs of existing phenotypes

In the simplest usage, the names in `pairs` are the names of phenotypes in
the cell seg data. In this case, `pairs` just lists the desired phenotypes.
For example, to pair `CK+` cells with `CD8+` cells, use the argument

```{r}
pairs = list(c('CK+', 'CD8+'))
```

For a single pair, a list is not required so this can be simplified to

```{r}
pairs = c('CK+', 'CD8+')
```

For multiple pairs, list each pair separately. For example, to pair `CK+` 
cells first with `CD8+` cells and then with `CD68+` cells, use the argument

```{r}
pairs = list(c('CK+', 'CD8+'),
             c('CK+', 'CD68+'))
```

### Defining new phenotypes

You may want to define a new phenotype using grouping or expressions as shown 
in the "Selecting phenotypes" sections above. To do
this, use the `phenotype_rules` argument to associate a `select_rows` rule
with a name; then use the new name in the pairs argument.

For example, to create a `T Cell` phenotype which matches `CD8+` and `FoxP3+`
phenotypes, and pair it with a `PDL1+ CK+` phenotype which 
applies a threshold to
tumor cells, use these arguments:

```{r}
pairs = c('PDL1+ CK+', 'T Cell')
phenotype_rules = list(
  'PDL1+ tumor'=list('CK+', ~`Entire Cell PDL1 (Opal 520) Mean`>3),
  'T Cell'=c('CD8+', 'FoxP3+'))
```

`phenotype_rules` only needs to include phenotypes which are not in the cell
seg data. For example, to extend the previous example to include a pairing
from `PDL1+ CK+` to `CD68+` cells, where `CD68+` is an existing phenotype,
extend the `pairs` argument without changing `phenotype_rules`:


```{r}
pairs = list(
  c('PDL1+ CK+', 'T Cell'),
  c('PDL1+ CK+', 'CD68+'))
phenotype_rules = list(
  'PDL1+ CK+'=list('CK+', ~`Entire Cell PDL1 (Opal 520) Mean`>3),
  'T Cell'=c('CD8+', 'FoxP3+')
)
```
