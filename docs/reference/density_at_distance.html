<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Estimate cell density at distance from a tissue boundary. — density_at_distance • phenoptr</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Estimate cell density at distance from a tissue boundary. — density_at_distance"><meta property="og:description" content="Given a cell seg table and an image containing masks for two tissue
classes, estimate the dependence of the density of cells of each
phenotype on the distance from the boundary between the two tissue classes."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">phenoptr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/reading_tables.html">Reading and exploring inForm tables</a>
    </li>
    <li>
      <a href="../articles/computing_distances.html">Computing inter-cellular distances</a>
    </li>
    <li>
      <a href="../articles/find_and_count_touching_cells.html">Find and count touching cells</a>
    </li>
    <li>
      <a href="../articles/reading_image_files.html">Reading and displaying inForm image Files</a>
    </li>
    <li>
      <a href="../articles/selecting_cells.html">Selecting cells within a cell segmentation table</a>
    </li>
  </ul></li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    news
  </a>
</li>
<li>
  <a href="https://github.com/akoyabio/phenoptr" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Estimate cell density at distance from a tissue boundary.</h1>
    <small class="dont-index">Source: <a href="https://github.com/akoyabio/phenoptr/blob/HEAD/R/density_at_distance.R" class="external-link"><code>R/density_at_distance.R</code></a></small>
    <div class="hidden name"><code>density_at_distance.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Given a cell seg table and an image containing masks for two tissue
classes, estimate the dependence of the density of cells of each
phenotype on the distance from the boundary between the two tissue classes.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">density_at_distance</span><span class="op">(</span>
  <span class="va">cell_seg_path</span>,
  <span class="va">phenotypes</span>,
  <span class="va">positive</span>,
  <span class="va">negative</span>,
  mask <span class="op">=</span> <span class="cn">FALSE</span>,
  pixels_per_micron <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"phenoptr.pixels.per.micron"</span><span class="op">)</span>,
  <span class="va">...</span>
<span class="op">)</span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>cell_seg_path</dt>
<dd><p>Path to a cell segmentation data file.</p></dd>
<dt>phenotypes</dt>
<dd><p>Optional named list of phenotypes to process.
<code>names(phenotypes)</code> are the names of the resulting phenotypes.
The values are in any format accepted by <code><a href="select_rows.html">select_rows</a></code>.
If omitted, will use all phenotypes in the cell seg data.</p></dd>
<dt>positive</dt>
<dd><p>Name of the tissue category used as positive distance,
e.g. "stroma".</p></dd>
<dt>negative</dt>
<dd><p>Name of the tissue category used as negative distance,
e.g. "tumor".</p></dd>
<dt>mask</dt>
<dd><p>If true, compensate for edge effects by masking the image
to exclude cells which are closer to the edge of the image than to the
tissue boundary.</p></dd>
<dt>pixels_per_micron</dt>
<dd><p>Conversion factor to microns.</p></dd>
<dt>...</dt>
<dd><p>Additional arguments passed to <code><a href="https://rdrr.io/pkg/spatstat.core/man/rhohat.html" class="external-link">rhohat</a></code>.
Default parameters are <code>method="ratio", smoother="kernel", bw="nrd"</code>.</p></dd>
</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>Returns a <code>list</code> containing four items:</p><dl><dt><code>points</code></dt>
<dd><p>The points used, marked with their phenotype,
a <code><a href="https://rdrr.io/pkg/spatstat.geom/man/ppp.object.html" class="external-link">ppp.object</a></code>.</p></dd>

<dt><code>rhohat</code></dt>
<dd><p>The density estimates (see Details).</p></dd>

<dt><code>distance</code></dt>
<dd><p>The distance map, a pixel image
(<code><a href="https://rdrr.io/pkg/spatstat.geom/man/im.object.html" class="external-link">im.object</a></code>).</p></dd>

<dt><code>mask</code></dt>
<dd><p>A mask matrix showing the locations which are closer to
the tissue boundary than to the border or other regions.</p></dd>


</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>The cell density estimate is computed by <code><a href="https://rdrr.io/pkg/spatstat.core/man/rhohat.html" class="external-link">rhohat</a></code>.
The signed distance from the boundary between the two tissue classes
is used as the covariate and density is estimated separately for each
phenotype. <code>rhohat</code> uses kernel density estimation to
estimate the dependence of cell count on distance and the dependence
of area on distance. The ratio of these two estimates is the estimate
of density vs distance.</p>
<p>The <code>rhohat</code> element of the returned list is a
<code>list</code> containing the results of the cell density
estimation for each phenotype. Each list value is a <code>rhohat</code> object,
see <code><a href="https://rdrr.io/pkg/spatstat.core/man/methods.rhohat.html" class="external-link">methods.rhohat</a></code>.</p>
<p>Density estimates are
in cells per square micron; multiply by 1,000,000 for cells per square
millimeter.</p>
    </div>
    <div id="edge-correction">
    <h2>Edge correction</h2>
    


<p>The <code><a href="https://rdrr.io/pkg/spatstat.core/man/rhohat.html" class="external-link">rhohat</a></code> function does not have any built-in
edge correction. This may lead to incorrect density estimates
because it does not account for cells at the edge of the image which may
be near a tissue boundary which is not part of the image.</p>
<p>The <code>mask</code> parameter, if set to <code>TRUE</code>, restricts the density estimation
to cells which are closer to the tissue boundary in the image than they are
to the edge of the image or any other tissue class.</p>
<p>For both <code>mask==TRUE</code> and <code>mask==FALSE</code>, the results tend to be unreliable
near the distance extremes because the tissue area at that distance
will be relatively small so random variation in cell counts is magnified.</p>
    </div>
    <div id="parallel-computation">
    <h2>Parallel computation</h2>
    


<p><code>density_at_distance</code> supports parallel computation using the
<code><a href="https://rdrr.io/pkg/foreach/man/foreach-package.html" class="external-link">foreach-package</a></code>. When this is enabled, the densities
for each phenotype will be computed in parallel. To use this feature,
you must enable a parallel backend, for example using
<code><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></code>.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>A. Baddeley, E. Rubak and R.Turner.
Spatial Point Patterns: Methodology and Applications with R.
Chapman and Hall/CRC Press, 2015. Sections 6.6.3-6.6.4.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>Other density estimation: 
<code><a href="density_bands.html">density_bands</a>()</code></p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span class="co"># Compute density for the sample data</span></span>
<span class="r-in"><span class="va">values</span> <span class="op">&lt;-</span> <span class="fu">density_at_distance</span><span class="op">(</span><span class="fu"><a href="sample_cell_seg_data.html">sample_cell_seg_path</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span class="r-in">  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"CD8+"</span>, <span class="st">"CD68+"</span>, <span class="st">"FoxP3+"</span><span class="op">)</span>,</span>
<span class="r-in">  positive<span class="op">=</span><span class="st">"Stroma"</span>, negative<span class="op">=</span><span class="st">"Tumor"</span><span class="op">)</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Registered S3 method overwritten by 'spatstat.geom':</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   method     from</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>   print.boxx cli </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>executing %dopar% sequentially: no parallel backend registered</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: spatstat.data</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: spatstat.geom</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> spatstat.geom 2.3-1</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: nlme</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Attaching package: 'nlme'</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> The following object is masked from 'package:dplyr':</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span>     collapse</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Loading required package: rpart</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> spatstat.core 2.3-2</span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># Combine all the densities into a single tibble</span></span>
<span class="r-in"><span class="co"># and filter out the extremes</span></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span class="r-in"><span class="va">all_rho</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">values</span><span class="op">$</span><span class="va">rhohat</span>, <span class="op">~</span><span class="va">.</span>, .id<span class="op">=</span><span class="st">'phenotype'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span class="r-in">  <span class="va">as_tibble</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">X</span><span class="op">&gt;=</span><span class="op">-</span><span class="fl">50</span>, <span class="va">X</span><span class="op">&lt;=</span><span class="fl">100</span><span class="op">)</span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to min; returning Inf</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to max; returning -Inf</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to min; returning Inf</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to max; returning -Inf</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to min; returning Inf</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to max; returning -Inf</span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># Plot the densities in a single plot</span></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all_rho</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">rho</span><span class="op">*</span><span class="fl">1000000</span>, color<span class="op">=</span><span class="va">phenotype</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in">  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span class="r-in">  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">'Distance from tumor boundary (microns)'</span>,</span>
<span class="r-in">       y<span class="op">=</span><span class="st">'Estimated cell density (cells per sq mm)'</span><span class="op">)</span></span>
<span class="r-plt img"><img src="density_at_distance-1.png" alt="" width="700" height="433"></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># Show the distance map with CD68+ cells superimposed</span></span>
<span class="r-in"><span class="fu"><a href="plot_diverging.html">plot_diverging</a></span><span class="op">(</span><span class="va">values</span><span class="op">$</span><span class="va">distance</span>, show_boundary<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span class="r-in">  title<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'Distance from tumor for CD68+cells'</span><span class="op">)</span>,</span>
<span class="r-in">  sub<span class="op">=</span><span class="st">'Positive (blue) distances are away from tumor'</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">values</span><span class="op">$</span><span class="va">points</span><span class="op">[</span><span class="va">values</span><span class="op">$</span><span class="va">points</span><span class="op">$</span><span class="va">marks</span><span class="op">==</span><span class="st">'CD68+'</span>, drop<span class="op">=</span><span class="cn">TRUE</span><span class="op">]</span>,</span>
<span class="r-in">  add<span class="op">=</span><span class="cn">TRUE</span>, use.marks<span class="op">=</span><span class="cn">FALSE</span>, cex<span class="op">=</span><span class="fl">0.5</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-plt img"><img src="density_at_distance-2.png" alt="" width="700" height="433"></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Kent S Johnson.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer></div>

  


  

  </body></html>

