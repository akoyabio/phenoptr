<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Computing inter-cellular distances • phenoptr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">phenoptr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/reading_tables.html">Reading and exploring inForm tables</a>
    </li>
    <li>
      <a href="../articles/computing_distances.html">Computing inter-cellular distances</a>
    </li>
    <li>
      <a href="../articles/find_and_count_touching_cells.html">Find and count touching cells</a>
    </li>
    <li>
      <a href="../articles/reading_image_files.html">Reading and displaying inForm image Files</a>
    </li>
    <li>
      <a href="../articles/selecting_cells.html">Selecting cells within a cell segmentation table</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    news
  </a>
</li>
<li>
  <a href="https://github.com/PerkinElmer/phenoptr">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Computing inter-cellular distances</h1>
                        <h4 class="author">Kent Johnson</h4>
            
            <h4 class="date">2017-08-17</h4>
          </div>

    
    
<div class="contents">
<style type="text/css">
img { 
  border: none;
}
table {
    width: auto !important;
}
</style>
<p><code>phenoptr</code> contains several functions which analyze and report on the spatial relationship between cells in a single field.</p>
<div id="nearest-neighbor-distances" class="section level2">
<h2 class="hasAnchor">
<a href="#nearest-neighbor-distances" class="anchor"></a>Nearest neighbor distances</h2>
<div id="computing-with-find_nearest_distance" class="section level3">
<h3 class="hasAnchor">
<a href="#computing-with-find_nearest_distance" class="anchor"></a>Computing with <code>find_nearest_distance</code>
</h3>
<p>The <code>find_nearest_distance</code> function finds per-cell nearest neighbor distances. For each cell in a sample, it finds the distances to the nearest neighbor cells in each of the provided phenotypes. The distances are returned in a <code>data_frame</code> with one column per phenotype.</p>
<p>For example, the <code>phenoptr</code> sample data <code>sample_cell_seg_data</code> contains 5 unique phenotypes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(phenoptr)

csd &lt;-<span class="st"> </span>sample_cell_seg_data
csd <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(Phenotype)</code></pre></div>
<pre><code># A tibble: 5 x 2
  Phenotype     n
      &lt;chr&gt; &lt;int&gt;
1     CD68+   417
2      CD8+   228
3       CK+  2257
4    FoxP3+   228
5     other  2942</code></pre>
<p>The <code>other</code> cells are not of interest, so first filter them out.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">csd &lt;-<span class="st"> </span>csd <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Phenotype<span class="op">!=</span><span class="st">'other'</span>)</code></pre></div>
<p>Calling <code>find_nearest_distance</code> on this file returns a <code>data_frame</code> with four columns and one row for each cell:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">distances &lt;-<span class="st"> </span><span class="kw"><a href="../reference/find_nearest_distance.html">find_nearest_distance</a></span>(csd)
<span class="kw">glimpse</span>(distances)</code></pre></div>
<pre><code>Observations: 3,130
Variables: 4
$ Distance to CD68+  &lt;dbl&gt; 29.529646, 38.082148, 36.674242, 73.119765,...
$ Distance to CD8+   &lt;dbl&gt; 18.03469, 64.37585, 67.57403, 91.44397, 37....
$ Distance to CK+    &lt;dbl&gt; 36.830694, 109.317199, 3.605551, 4.031129, ...
$ Distance to FoxP3+ &lt;dbl&gt; 16.347783, 40.140379, 30.870698, 65.408333,...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>(csd)</code></pre></div>
<pre><code>[1] 3130</code></pre>
<p>To create a combined data frame, use <code><a href="http://dplyr.tidyverse.org/reference/bind.html">dplyr::bind_cols</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">csd_with_distance &lt;-<span class="st"> </span><span class="kw">bind_cols</span>(csd, distances)</code></pre></div>
<p>Note: Cell positions in a cell seg data file are relative to the top-left corner of the field, so calling <code>find_nearest_distance</code> on a merged data file will compute incorrect values. One way to add distance columns to a merged data file is to use <code><a href="http://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by</a></code> to process each field separately. For example, if <code>merged</code> contains merged cell seg data, add distance columns with this code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">merged_with_distance &lt;-<span class="st"> </span>merged <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="st">`</span><span class="dt">Sample Name</span><span class="st">`</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/do.html">do</a></span>(dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span>(., <span class="kw"><a href="../reference/find_nearest_distance.html">find_nearest_distance</a></span>(.)))</code></pre></div>
</div>
<div id="analyzing-nearest-neighbor-distances" class="section level3">
<h3 class="hasAnchor">
<a href="#analyzing-nearest-neighbor-distances" class="anchor"></a>Analyzing nearest neighbor distances</h3>
<p>Once the nearest neighbors have been computed per cell, standard aggregation, analysis and plotting commands can be used to examine the results. For example, find the mean nearest neighbor distances by phenotype:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">csd_with_distance <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Phenotype) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">'Distance to'</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">summarize_all</span>(<span class="op">~</span><span class="kw">round</span>(<span class="kw">mean</span>(.), <span class="dv">1</span>))</code></pre></div>
<pre><code># A tibble: 4 x 5
  Phenotype `Distance to CD68+` `Distance to CD8+` `Distance to CK+`
      &lt;chr&gt;               &lt;dbl&gt;              &lt;dbl&gt;             &lt;dbl&gt;
1     CD68+                14.2               30.6              23.1
2      CD8+                23.1               17.5              19.3
3       CK+                44.3               48.2               7.9
4    FoxP3+                19.1               29.1              23.3
# ... with 1 more variables: `Distance to FoxP3+` &lt;dbl&gt;</code></pre>
<p>Show the distribution of distances in a density plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(csd_with_distance, <span class="kw">aes</span>(<span class="st">`</span><span class="dt">Distance to CD8+</span><span class="st">`</span>, <span class="dt">color=</span>Phenotype)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">size=</span><span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>()</code></pre></div>
<p><img src="computing_distances_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<hr>
</div>
</div>
<div id="cells-within-a-radius" class="section level2">
<h2 class="hasAnchor">
<a href="#cells-within-a-radius" class="anchor"></a>Cells within a radius</h2>
<div id="computing-with-count_within" class="section level3">
<h3 class="hasAnchor">
<a href="#computing-with-count_within" class="anchor"></a>Computing with <code>count_within</code>
</h3>
<p>The <code>count_within</code> function looks at the number of cells within a radius of another cell and returns summary measures. For example, use <code>count_within</code> to find the number of <code>CD68+</code> cells having a <code>CK+</code> cell within 25 microns:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/count_within.html">count_within</a></span>(csd, <span class="dt">from=</span><span class="st">'CD68+'</span>, <span class="dt">to=</span><span class="st">'CK+'</span>, <span class="dt">radius=</span><span class="dv">25</span>)</code></pre></div>
<pre><code># A tibble: 1 x 5
  radius from_count to_count from_with within_mean
   &lt;dbl&gt;      &lt;int&gt;    &lt;int&gt;     &lt;int&gt;       &lt;dbl&gt;
1     25        417     2257       274    3.278177</code></pre>
<p>In this result, <code>from_count</code> and <code>to_count</code> are the total numbers of eligible cells. They agree with the counts in the first table in this vignette. <code>from_with</code> is the number of <code>CD68+</code> cells having at least one <code>CK+</code> cell within 25 micron. <code>within_mean</code> is the average number of <code>CK+</code> cells found within 25 micron of each <code>CD68+</code> cell.</p>
<p>Note there are some subtleties to <code>count_within</code>. Most importantly, it is not symmetric. In this example, the number of <code>CK+</code> cells with a <code>CD68+</code> within 25 microns is not the same as the number of <code>CD68+</code> cells with a <code>CK+</code> cell within 25 microns.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/count_within.html">count_within</a></span>(csd, <span class="dt">from=</span><span class="st">'CK+'</span>, <span class="dt">to=</span><span class="st">'CD68+'</span>, <span class="dt">radius=</span><span class="dv">25</span>)</code></pre></div>
<pre><code># A tibble: 1 x 5
  radius from_count to_count from_with within_mean
   &lt;dbl&gt;      &lt;int&gt;    &lt;int&gt;     &lt;int&gt;       &lt;dbl&gt;
1     25       2257      417       664   0.6056712</code></pre>
<p>Please see <code>help(count_within)</code> for details.</p>
</div>
<div id="count-multiple-files-or-phenotypes-using-count_within_batch" class="section level3">
<h3 class="hasAnchor">
<a href="#count-multiple-files-or-phenotypes-using-count_within_batch" class="anchor"></a>Count multiple files or phenotypes using <code>count_within_batch</code>
</h3>
<p>You may want to run <code>count_within</code> on an entire directory of cell seg data files, or to count multiple combinations of phenotypes. Both of these are possible using <code>count_within_batch</code>. This function takes the path to a directory that contains multiple cell seg data files. The <code>pairs</code> and <code>category</code> parameters are lists and may contain multiple entries.</p>
<p>For example, the following commands will count <code>FoxP3+</code> cells with a <code>CD8+</code> or <code>CK+</code> cell within 10 or 25 microns. Separate counts are returned for each <code>to</code> phenotype and for <code>Tumor</code> and <code>Stroma</code> tissue categories. Counts will be calculated for all <code>cell_seg_data.txt</code> files in <code>my_directory</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">base_path &lt;-<span class="st"> "/path/to/my_directory"</span>

pairs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">'FoxP3+'</span>, <span class="st">'CD8+'</span>),
              <span class="kw">c</span>(<span class="st">'FoxP3+'</span>, <span class="st">'CK+'</span>))
radii &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">25</span>)
categories &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'Stroma'</span>, <span class="st">'Tumor'</span>)

<span class="kw"><a href="../reference/count_within_batch.html">count_within_batch</a></span>(base_path, pairs, radii, categories)</code></pre></div>
<p>See <code>help(count_within_batch)</code> and the vignette <em>Selecting cells within a cell segmentation table</em> for additional details.</p>
<hr>
</div>
</div>
<div id="visualizing-nearest-neighbors" class="section level2">
<h2 class="hasAnchor">
<a href="#visualizing-nearest-neighbors" class="anchor"></a>Visualizing nearest neighbors</h2>
<p>The <code>spatial_distribution_report</code> function is a bit different from the other functions mentioned in this vignette. Rather than calculate and return distance metrics, it creates a report which shows visually the nearest neighbor relations between two phenotypes in a single field. Because the result is a stand-alone HTML file, it can’t easily be demonstrated in a vignette. For an example, copy and paste this code into your own copy of R. It will create a sample report in your user directory.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cell_seg_path &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sample_cell_seg_data.html">sample_cell_seg_path</a></span>()

pairs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">'CD68+'</span>, <span class="st">'CD8+'</span>))
colors &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">'CD68+'</span>=<span class="st">'magenta'</span>, <span class="st">'CD8+'</span>=<span class="st">'yellow'</span>)
out_path &lt;-<span class="st"> </span><span class="kw">path.expand</span>(<span class="st">'~/spatial_distribution_report.html'</span>)

<span class="kw"><a href="../reference/spatial_distribution_report.html">spatial_distribution_report</a></span>(cell_seg_path, pairs, colors, <span class="dt">output_path=</span>out_path)</code></pre></div>
<p>To create reports for all cell seg data files in a directory, first define <code>phenotypes</code> and <code>colors</code> as above. Use <code>list_cell_seg_files</code> to find all the files. Then call <code>spatial_distribution_report</code> for each file. This will create reports in the same directory as the data files.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">base_path &lt;-<span class="st"> '/path/to/data/'</span>
paths &lt;-<span class="st"> </span><span class="kw"><a href="../reference/list_cell_seg_files.html">list_cell_seg_files</a></span>(base_path)
<span class="cf">for</span> (path <span class="cf">in</span> paths)
  <span class="kw"><a href="../reference/spatial_distribution_report.html">spatial_distribution_report</a></span>(path, pairs, colors)</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#nearest-neighbor-distances">Nearest neighbor distances</a></li>
      <li><a href="#cells-within-a-radius">Cells within a radius</a></li>
      <li><a href="#visualizing-nearest-neighbors">Visualizing nearest neighbors</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Kent Johnson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
