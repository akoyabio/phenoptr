<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Computing Inter-cellular Distances • phenoptr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">phenoptr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/computing_distances.html">Computing Inter-cellular Distances</a>
    </li>
    <li>
      <a href="../articles/reading_image_files.html">Reading and Displaying inForm Image Files</a>
    </li>
    <li>
      <a href="../articles/selecting_cells.html">Selecting cells within a cell segmentation table</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/PerkinElmer/phenoptr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Computing Inter-cellular Distances</h1>
                        <h4 class="author">Kent Johnson</h4>
            
            <h4 class="date">2017-07-18</h4>
          </div>

    
    
<div class="contents">
<style type="text/css">
img { 
  border: none;
}
table {
    width: auto !important;
}
</style>
<p><code>phenoptr</code> contains several functions which analyze and report on the spatial relationship between cells in a single field.</p>
<div id="nearest-neighbor-distances" class="section level2">
<h2 class="hasAnchor">
<a href="#nearest-neighbor-distances" class="anchor"></a>Nearest neighbor distances</h2>
<div id="computing-with-find_nearest_distance" class="section level3">
<h3 class="hasAnchor">
<a href="#computing-with-find_nearest_distance" class="anchor"></a>Computing with <code>find_nearest_distance</code>
</h3>
<p>The <code>find_nearest_distance</code> function finds per-cell nearest neighbor distances. For each cell and each phenotype in a sample, it finds the nearest neighbor of that phenotype. The distances are returned in a <code>data_frame</code> with one column per phenotype.</p>
<p>For example, the <code>phenoptr</code> sample data <code>sample_cell_seg_data</code> contains 6 unique phenotypes:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(phenoptr)

csd =<span class="st"> </span>sample_cell_seg_data
csd %&gt;%<span class="st"> </span><span class="kw">count</span>(Phenotype)</code></pre></div>
<pre><code># A tibble: 6 x 2
        Phenotype     n
            &lt;chr&gt; &lt;int&gt;
1   cytotoxic CD8   293
2      helper CD4    59
3 macrophage CD68   359
4           other  1710
5     T reg Foxp3     2
6           tumor  3303</code></pre>
<p>This file contains only two FoxP3+ cells, and the ‘other’ cells are not of interest, so first filter them out.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">csd =<span class="st"> </span>csd %&gt;%<span class="st"> </span><span class="kw">filter</span>(!Phenotype %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">'T reg Foxp3'</span>, <span class="st">'other'</span>))</code></pre></div>
<p>Calling <code>find_nearest_distance</code> on this file returns a <code>data_frame</code> with four columns and one row for each cell:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">distances =<span class="st"> </span><span class="kw"><a href="../reference/find_nearest_distance.html">find_nearest_distance</a></span>(csd)
<span class="kw">glimpse</span>(distances)</code></pre></div>
<pre><code>Observations: 4,014
Variables: 4
$ Distance to cytotoxic CD8   &lt;dbl&gt; 15.231546, 21.505813, 14.008926, 1...
$ Distance to helper CD4      &lt;dbl&gt; 140.12584, 136.88042, 137.29530, 1...
$ Distance to macrophage CD68 &lt;dbl&gt; 11.597414, 28.160256, 9.552487, 24...
$ Distance to tumor           &lt;dbl&gt; 3.201562, 9.552487, 3.201562, 13.7...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>(csd)</code></pre></div>
<pre><code>[1] 4014</code></pre>
<p>To create a combined data frame, use <code><a href="http://dplyr.tidyverse.org/reference/bind.html">dplyr::bind_cols</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">csd_with_distance =<span class="st"> </span><span class="kw">bind_cols</span>(csd, distances)</code></pre></div>
<p>Note: Cell positions in a cell seg data file are relative to the top-left corner of the field, so calling <code>find_nearest_distance</code> on a merged data file will fail. One way to add distance columns to a merged data file is to use <code><a href="http://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by</a></code> to process each field separately. For example, if <code>merged</code> contains merged cell seg data, add distance columns with this code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">merged_with_distance =<span class="st"> </span>merged %&gt;%
<span class="st">  </span>dplyr::<span class="kw">group_by</span>(<span class="st">`</span><span class="dt">Sample Name</span><span class="st">`</span>) %&gt;%
<span class="st">  </span>dplyr::<span class="kw">do</span>(dplyr::<span class="kw">bind_cols</span>(., <span class="kw"><a href="../reference/find_nearest_distance.html">find_nearest_distance</a></span>(.)))</code></pre></div>
</div>
<div id="analyzing-nearest-neighbor-distances" class="section level3">
<h3 class="hasAnchor">
<a href="#analyzing-nearest-neighbor-distances" class="anchor"></a>Analyzing nearest neighbor distances</h3>
<p>Once the nearest neighbors have been computed per cell, standard aggregation, analysis and plotting commands can be used to examine the results. For example, find the mean nearest neighbor distances by phenotype:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">csd_with_distance %&gt;%<span class="st"> </span><span class="kw">group_by</span>(Phenotype) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">'Distance to'</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">summarize_all</span>(~<span class="kw">round</span>(<span class="kw">mean</span>(.), <span class="dv">1</span>))</code></pre></div>
<pre><code># A tibble: 4 x 5
        Phenotype `Distance to cytotoxic CD8` `Distance to helper CD4`
            &lt;chr&gt;                       &lt;dbl&gt;                    &lt;dbl&gt;
1   cytotoxic CD8                        21.4                     75.0
2      helper CD4                        24.8                     34.8
3 macrophage CD68                        31.6                     70.2
4           tumor                        38.1                     91.8
# ... with 2 more variables: `Distance to macrophage CD68` &lt;dbl&gt;,
#   `Distance to tumor` &lt;dbl&gt;</code></pre>
<p>Show the distribution of distances in a density plot:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(csd_with_distance, <span class="kw">aes</span>(<span class="st">`</span><span class="dt">Distance to helper CD4</span><span class="st">`</span>, <span class="dt">color=</span>Phenotype)) +
<span class="st">  </span><span class="kw">geom_density</span>()</code></pre></div>
<p><img src="computing_distances_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
</div>
</div>
<div id="cells-within-a-radius" class="section level2">
<h2 class="hasAnchor">
<a href="#cells-within-a-radius" class="anchor"></a>Cells within a radius</h2>
<div id="computing-with-count_within" class="section level3">
<h3 class="hasAnchor">
<a href="#computing-with-count_within" class="anchor"></a>Computing with <code>count_within</code>
</h3>
<p>The <code>count_within</code> function looks at the number of cells within a radius of another cell and returns summary measures. For example, use <code>count_within</code> to find the number of macrophages having a tumor cell within 25 microns:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/count_within.html">count_within</a></span>(csd, <span class="dt">from=</span><span class="st">'macrophage CD68'</span>, <span class="dt">to=</span><span class="st">'tumor'</span>, <span class="dt">radius=</span><span class="dv">25</span>)</code></pre></div>
<pre><code># A tibble: 1 x 5
  radius from_count to_count from_with within_mean
   &lt;dbl&gt;      &lt;int&gt;    &lt;int&gt;     &lt;int&gt;       &lt;dbl&gt;
1     25        359     3303       257    5.183844</code></pre>
<p>In this result, <code>from_count</code> and <code>to_count</code> are the total numbers of eligible cells. They agree with the counts in the first table in this vignette. <code>from_with</code> is the number of <code>macrophage CD68</code> cells having at least one <code>tumor</code> cell within 25 μm. <code>within_mean</code> is the average number of <code>tumor</code> cells found within 25 μm of each <code>macrophage CD68</code> cell.</p>
<p>Note there are some subtleties to <code>count_within</code>. Most importantly, it is not symmetric. In this example, the number of <code>tumor</code> cells with a <code>macrophage CD68</code> within 25 microns is not the same as the number of <code>macrophage CD68</code> cells with a <code>tumor</code> cell within 25 microns.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/count_within.html">count_within</a></span>(csd, <span class="dt">from=</span><span class="st">'tumor'</span>, <span class="dt">to=</span><span class="st">'macrophage CD68'</span>, <span class="dt">radius=</span><span class="dv">25</span>)</code></pre></div>
<pre><code># A tibble: 1 x 5
  radius from_count to_count from_with within_mean
   &lt;dbl&gt;      &lt;int&gt;    &lt;int&gt;     &lt;int&gt;       &lt;dbl&gt;
1     25       3303      359      1195   0.5634272</code></pre>
<p>Please see <code>help(count_within)</code> for details.</p>
</div>
<div id="count-multiple-files-or-phenotypes-using-count_within_batch" class="section level3">
<h3 class="hasAnchor">
<a href="#count-multiple-files-or-phenotypes-using-count_within_batch" class="anchor"></a>Count multiple files or phenotypes using <code>count_within_batch</code>
</h3>
<p>You may want to run <code>count_within</code> on an entire directory of cell seg data files, or to count multiple combinations of phenotypes. Both of these are possible using <code>count_within_batch</code>. Instead of a <code>data_frame</code>, you pass it the path to a directory containing multiple cell seg data files. The <code>from</code>, <code>to</code>, and <code>category</code> parameters are lists and may contain multiple entries.</p>
<p>For example, the following commands will count <code>T Reg</code> cells with a <code>Cytotoxic T Cell</code> or <code>PDL1+ Tumor Cell</code> within 10 or 25 μm, with separate counts for each <code>to</code> phenotype and for <code>tumor</code> and <code>stroma</code> tissue categories. Counts will be calculated for all <code>cell_seg_data.txt</code> files in <code>my_directory</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">base_path =<span class="st"> "/path/to/my_directory"</span>

from =<span class="st"> </span><span class="kw">list</span>(<span class="st">'T Reg'</span>)
to =<span class="st"> </span><span class="kw">list</span>(<span class="st">'Cytotoxic T Cell'</span>, <span class="st">'PDL1+ Tumor Cell'</span>)
radii =<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">25</span>)
categories =<span class="st"> </span><span class="kw">c</span>(<span class="st">'stroma'</span>, <span class="st">'tumor'</span>)

<span class="kw"><a href="../reference/count_within_batch.html">count_within_batch</a></span>(base_path, from, to, radii, categories)</code></pre></div>
<p>See <code>help(count_within_batch)</code> for additional details.</p>
</div>
</div>
<div id="visualizing-nearest-neighbors" class="section level2">
<h2 class="hasAnchor">
<a href="#visualizing-nearest-neighbors" class="anchor"></a>Visualizing nearest neighbors</h2>
<p>The <code>spatial_distribution_report</code> function is a bit different from the other functions mentioned in this vignette. Rather than calculate and return distance metrics, it creates a report which shows visually the nearest neighbor relations between two phenotypes in a single field. Because the result is a stand-alone HTML file, it can’t easily be demonstrated in a vignette. For an example, copy and paste this code into your own copy of R. It will create a sample report in your user directory.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cell_seg_path =<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"TMA"</span>,
                       <span class="st">"Core[1,5,6,1]_[21302,15107]_cell_seg_data.txt"</span>,
                       <span class="dt">package =</span> <span class="st">"phenoptr"</span>)

phenotypes =<span class="st"> </span><span class="kw">c</span>(<span class="st">"macrophage CD68"</span>, <span class="st">"cytotoxic CD8"</span>)
colors =<span class="st"> </span><span class="kw">c</span>(<span class="st">'red'</span>, <span class="st">'blue'</span>)
out_path =<span class="st"> </span><span class="kw">path.expand</span>(<span class="st">'~/spatial_distribution_report.html'</span>)

<span class="kw"><a href="../reference/spatial_distribution_report.html">spatial_distribution_report</a></span>(cell_seg_path, phenotypes, colors, out_path)</code></pre></div>
<p>To create reports for all cell seg data files in a directory, first define <code>phenotypes</code> and <code>colors</code> as above. Use <code>list_cell_seg_files</code> to find all the files. Then call <code>spatial_distribution_report</code> for each file. This will create reports in the same directory as the data files.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">base_path =<span class="st"> '/path/to/data/'</span>
paths =<span class="st"> </span><span class="kw"><a href="../reference/list_cell_seg_files.html">list_cell_seg_files</a></span>(base_path)
for (path in paths)
  <span class="kw"><a href="../reference/spatial_distribution_report.html">spatial_distribution_report</a></span>(path, phenotypes, colors)</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#nearest-neighbor-distances">Nearest neighbor distances</a></li>
      <li><a href="#cells-within-a-radius">Cells within a radius</a></li>
      <li><a href="#visualizing-nearest-neighbors">Visualizing nearest neighbors</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Kent Johnson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
