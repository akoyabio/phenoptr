<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Find and count touching cells • phenoptr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Find and count touching cells">
<meta property="og:description" content="phenoptr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">phenoptr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/reading_tables.html">Reading and exploring inForm tables</a>
    </li>
    <li>
      <a href="../articles/computing_distances.html">Computing inter-cellular distances</a>
    </li>
    <li>
      <a href="../articles/find_and_count_touching_cells.html">Find and count touching cells</a>
    </li>
    <li>
      <a href="../articles/reading_image_files.html">Reading and displaying inForm image Files</a>
    </li>
    <li>
      <a href="../articles/selecting_cells.html">Selecting cells within a cell segmentation table</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    news
  </a>
</li>
<li>
  <a href="https://github.com/akoyabio/phenoptr">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Find and count touching cells</h1>
                        <h4 class="author">Kent Johnson</h4>
            
            <h4 class="date">2020-04-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/akoyabio/phenoptr/blob/master/vignettes/find_and_count_touching_cells.Rmd"><code>vignettes/find_and_count_touching_cells.Rmd</code></a></small>
      <div class="hidden name"><code>find_and_count_touching_cells.Rmd</code></div>

    </div>

    
    
<p>The <code>count_touching_cells</code> function uses morphological analysis of nuclear and membrane segmentation maps to find touching cells of paired phenotypes. It reports the number of touching cells found and, optionally, writes image files showing the touching cells.</p>
<p><code>count_touching_cells</code> uses the results of inForm cell segmentation to determine which cells are touching. It uses both nuclear and membrane segmentation to determine the extent of each cell.</p>
<div id="count-touching-cells-with-existing-phenotypes" class="section level2">
<h2 class="hasAnchor">
<a href="#count-touching-cells-with-existing-phenotypes" class="anchor"></a>Count touching cells with existing phenotypes</h2>
<p><code>count_touching_cells</code> processes a single field and multiple pairs of phenotypes. The specification of pairs and phenotypes is flexible to accommodate any requirement. The simplest case uses the phenotype names from inForm to select cells. For this case, only the <code>pairs</code> argument is needed.</p>
<p>For example, this code finds and visualizes touches between <code>CK+</code> and <code>CD8+</code> cells, and also between <code>CK+</code> and <code>CD68+</code> cells:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">phenoptr</span>)

<span class="no">cell_seg_path</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/sample_cell_seg_data.html">sample_cell_seg_path</a></span>()
<span class="no">pairs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CK+'</span>, <span class="st">'CD8+'</span>),
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CK+'</span>, <span class="st">'CD68+'</span>)
)
<span class="no">colors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">'CK+'</span><span class="kw">=</span><span class="st">'cyan'</span>, <span class="st">'CD8+'</span><span class="kw">=</span><span class="st">'yellow'</span>, <span class="st">'CD68+'</span><span class="kw">=</span><span class="st">'magenta'</span>)
<span class="fu"><a href="../reference/count_touching_cells.html">count_touching_cells</a></span>(<span class="no">cell_seg_path</span>, <span class="no">pairs</span>, <span class="no">colors</span>)</pre></body></html></div>
<p><small></small></p>
<pre><code>## # A tibble: 2 x 9
##   slide_id source phenotype1 phenotype2 total1 total2 p1_touch_p2 p2_touch_p1
##   &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
## 1 Set4_1-~ Set4_~ CK+        CD8+         2257    228         148          95
## 2 Set4_1-~ Set4_~ CK+        CD68+        2257    417         250         163
## # ... with 1 more variable: touch_pairs &lt;dbl&gt;</code></pre>
<p></p>
</div>
<div id="count-touching-cells-with-new-phenotypes" class="section level2">
<h2 class="hasAnchor">
<a href="#count-touching-cells-with-new-phenotypes" class="anchor"></a>Count touching cells with new phenotypes</h2>
<p>For more flexibility, create new compound phenotypes using the <code>phenotype_rules</code> argument. For example, this code repeats the previous analysis limiting it to tumor cells with PDL1 above a threshold. Note that <code>phenotype_rules</code> only needs to include definitions for phenotypes which don’t match the names in <code>pairs</code>.</p>
<div class="panel panel-default">
<div class="panel-body">
See the tutorial <a href="https://akoyabio.github.io/phenoptr/articles/selecting_cells.html">Selecting cells within a cell segmentation table</a> for more details on selecting pairs.
</div>
</div>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">pairs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CK+ PDL1+'</span>, <span class="st">'CD8+'</span>),
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'CK+ PDL1+'</span>, <span class="st">'CD68+'</span>)
)

<span class="no">phenotype_rules</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="st">'CK+ PDL1+'</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">'CK+'</span>, ~<span class="no">`Entire Cell PDL1 (Opal 520) Mean`</span><span class="kw">&gt;</span><span class="fl">3</span>)
)
<span class="no">colors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">'CK+ PDL1+'</span><span class="kw">=</span><span class="st">'cyan'</span>, <span class="st">'CD8+'</span><span class="kw">=</span><span class="st">'yellow'</span>, <span class="st">'CD68+'</span><span class="kw">=</span><span class="st">'magenta'</span>)
<span class="fu"><a href="../reference/count_touching_cells.html">count_touching_cells</a></span>(<span class="no">cell_seg_path</span>, <span class="no">pairs</span>, <span class="no">colors</span>, <span class="no">phenotype_rules</span>)</pre></body></html></div>
</div>
<div id="count-touching-cells-for-multiple-fields" class="section level2">
<h2 class="hasAnchor">
<a href="#count-touching-cells-for-multiple-fields" class="anchor"></a>Count touching cells for multiple fields</h2>
<p>Using <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map</a></code>, you can find touching cells for all cell seg data files in a single directory.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># Directory containing data files</span>
<span class="no">base_path</span> <span class="kw">&lt;-</span> <span class="st">'/path/to/data'</span>

<span class="co"># A subdirectory for the results</span>
<span class="no">output_base</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">base_path</span>, <span class="st">'touches'</span>)

<span class="co"># All cell seg data files in base_path</span>
<span class="no">files</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/list_cell_seg_files.html">list_cell_seg_files</a></span>(<span class="no">base_path</span>)

<span class="co"># Count and visualize touching cells</span>
<span class="no">touch_counts</span> <span class="kw">&lt;-</span> <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_df</a></span>(<span class="no">files</span>, <span class="kw">function</span>(<span class="no">path</span>) {
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">'Processing'</span>, <span class="no">path</span>, <span class="st">'\n'</span>)
  <span class="fu"><a href="../reference/count_touching_cells.html">count_touching_cells</a></span>(<span class="no">path</span>, <span class="no">pairs</span>, <span class="no">colors</span>, <span class="no">phenotype_rules</span>,
                       <span class="kw">output_base</span><span class="kw">=</span><span class="no">output_base</span>)
})</pre></body></html></div>
<p>The result of the above is a <code>tibble</code> which may be written to a CSV file:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">touches_path</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">output_base</span>, <span class="st">'TouchCounts.csv'</span>)
<span class="kw pkg">readr</span><span class="kw ns">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span>(<span class="no">touch_counts</span>, <span class="no">touches_path</span>)</pre></body></html></div>
<div class="panel panel-default">
<div class="panel-body">
The tutorial <a href="https://akoyabio.github.io/phenoptrExamples/articles/count_touches.html">Aggregating touch counts</a> in the <code>phenoptrExamples</code> package demonstrates aggregation across multiple fields from multiple samples.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kent S Johnson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
